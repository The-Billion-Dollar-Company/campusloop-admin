# CampusLoop Admin Dashboard - AI Coding Instructions

## Project Overview
React 19 + TypeScript 5.8 + Vite 7 admin dashboard for CampusLoop - a university-based marketplace platform. Pure admin-only interface for managing users (verify/suspend) and marketplace items (approve/reject). Uses Redux Toolkit Query with Axios for API communication and JWT cookie-based authentication.

**Key Constraint**: This is admin-only—no public pages, no user registration UI. Redirect root `/` to `/login`.

## Architecture Patterns

### Authentication & Authorization
- **Admin-Only Access**: Only `ADMIN` and `SUPER_ADMIN` roles can access `/admin/*`
- **University Email Required**: All logins must use `@cse.bubt.edu.bd` email addresses (Zod validation)
- **JWT Cookie Auth**: Backend uses HTTP-only cookies (no Firebase/OTP/localStorage tokens)
- **Route Protection**: `withAuth(Component, role.admin)` HOC in `src/utils/withAuth.tsx`
  - Shows loading spinner while `useUserInfoQuery()` fetches `/auth/me`
  - Redirects unauthenticated users to `/login`
  - Redirects non-admin roles to `/unauthorized`
  - **Critical**: Always wait for `isLoading` to complete before rendering—prevents redirect loops

### Routing System
- **Declarative Routes**: Auto-generated from sidebar config in `src/routes/adminSIdebarRoutes.ts`
- **Root Redirect**: `/` → `/login` (no public home page)
- **Routes Generated by**: `generateRoutes()` in `src/utils/generateRoutes.ts` reads `adminSidebarItems` array
- **Structure**: 
  ```typescript
  const adminSidebarItems = [
    {
      title: "Dashboard",
      items: [{ title: "Analytics", url: "/admin/analytics", component: Analytics }]
    },
    {
      title: "Management", 
      items: [
        { title: "Users", url: "/admin/users", component: ManageUsers },
        { title: "Items", url: "/admin/items", component: ManageItems }
      ]
    }
  ];
  ```
- **Adding New Routes**: Update `adminSidebarRoutes.ts`, then `generateRoutes()` auto-wires the sidebar + routing

### State Management (Redux Toolkit Query)
- **Base Query**: Custom `axiosBaseQuery()` in `src/redux/axiosBaseQuery.ts` wraps Axios
- **Axios Config**: `src/lib/axios.ts` sets `withCredentials: true` and base URL from `VITE_BASE_URL`
- **Cache Tags**: `["USERS", "ITEMS", "USER", "ITEM"]` for smart invalidation
  - `useGetAllUsersQuery` provides `"USERS"` tag
  - `useUpdateUserStatusMutation` invalidates `"USERS"` to auto-refetch tables
- **API Files** (all inject into `baseApi` from `src/redux/baseApi.ts`):
  - `auth.api.ts` - Login, logout, userInfo (GET /auth/me)
  - `admin.api.ts` - User CRUD (GET /admin/users, PATCH status, DELETE)
  - `item.api.ts` - Item CRUD (GET /admin/items, PATCH status, DELETE)
  - `dashboard.api.ts` - Analytics (GET /admin/dashboard/stats, recent-activity)

### Admin Features (Pages + Dialogs)

#### User Management (`/admin/users`)
- **View Dialog**: Eye button → Modal showing user details (name, email, ID, role, status, verified flag)
- **Confirmation AlertDialogs** for all actions:
  - **Verify** (PENDING → ACTIVE + isVerified=true): Calls `updateStatus({ userId, isStatus: ACTIVE, isVerified: true })`
  - **Suspend** (ACTIVE → SUSPEND): Calls `updateStatus({ userId, isStatus: SUSPEND })`
  - **Activate** (SUSPEND → ACTIVE)
  - **Delete**: Calls `deleteUser(userId)` with irreversible warning
- **Filters**: Real-time search by name/email, status dropdown (ALL/PENDING/ACTIVE/SUSPEND)
- **Pagination**: Server-side with page/limit params, client-side prev/next buttons
- **Status Badges**: Color-coded (yellow=PENDING, green=ACTIVE, red=SUSPEND)

#### Item Management (`/admin/items`)
- **View Dialog**: Eye button → Modal with item details (title, price, owner, categories, status, availability, description)
- **Confirmation AlertDialogs**:
  - **Publish** (PENDING → PUBLISHED): `updateStatus({ itemId, status: PUBLISHED })`
  - **Reject** (PENDING → CANCEL): `updateStatus({ itemId, status: CANCEL })`
  - **Delete**: `deleteItem(itemId)`
- **Filters**: Search by title, status dropdown (ALL/PENDING/PUBLISHED/CANCEL)
- **Pagination**: Same as users
- **Owner Populated**: `ownerId` is an `IUser` object (name, email), not just a string ID

#### Dashboard Analytics (`/admin/analytics`)
- **8 Stat Cards**: Fetches `GET /admin/dashboard/stats` for total/active/pending/suspended users + items breakdown
- **Recent Activity**: Two cards showing last 5 users and items with status badges
- **All Data Real-Time**: Uses `useGetDashboardStatsQuery()` and `useGetRecentActivityQuery({ limit: 5 })`

### Form Handling
- **Login Form** (`src/components/modules/Authentication/LoginForm.tsx`):
  ```typescript
  const schema = z.object({
    email: z.string().email().refine(
      (email) => email.endsWith("@cse.bubt.edu.bd"),
      "Must use university email"
    ),
    password: z.string().min(6),
  });
  ```
- **Pattern**: React Hook Form + Zod resolver + shadcn/ui inputs

### UI Components (shadcn/ui)
- **Modals**: Dialog (view modals) + AlertDialog (confirmations)
- **Tables**: Table component with TableHeader, TableBody, TableRow, TableCell
- **Badges**: Custom color objects (PENDING=yellow, ACTIVE=green, SUSPEND=red)
- **Buttons**: Eye icon for view, CheckCircle for verify, Ban for suspend, Trash for delete
- **Dark Mode**: `next-themes` provider in `src/provider/theme-provider.tsx`
- **Utils**: `cn()` from `src/lib/utils.ts` merges Tailwind classes

## TypeScript Types (const objects, not enums)
```typescript
// Using const objects for erasableSyntaxOnly compliance
export const Status = { PENDING: "PENDING", ACTIVE: "ACTIVE", SUSPEND: "SUSPEND" } as const;
export type Status = typeof Status[keyof typeof Status];

export const ItemStatus = { PENDING: "PENDING", PUBLISHED: "PUBLISHED", CANCEL: "CANCEL" } as const;
export type ItemStatus = typeof ItemStatus[keyof typeof ItemStatus];

export interface IUser {
  _id: string; name: string; email: string; universityId?: string;
  activeRole: "BUYER" | "SELLER" | "ADMIN" | "SUPER_ADMIN";
  isVerified: boolean; isStatus: Status;
}

export interface IItem {
  _id: string; ownerId: string | IUser; title: string; price: number;
  status: ItemStatus; availability: Availability;
  sellingCategory: "RENT" | "SELL" | "SKILL";
  objectCategory: "ELECTRONICS" | "BOOKS" | "FURNITURE" | ...;
}
```

## Development Workflow

### Build & Run
```bash
npm run dev       # Vite dev server on http://localhost:5173 with HMR
npm run build     # TypeScript check + Vite build → dist/
npm run lint      # ESLint (not strict by default)
```

### Adding New Admin Features (5-step pattern)
1. **Create Page**: `src/pages/Admin/NewFeature.tsx` (use ManageUsers.tsx as template)
2. **Add Sidebar Route**: Update `src/routes/adminSidebarRoutes.ts` with new item
3. **Create API**: Add endpoints to `src/redux/features/admin/*.api.ts` or new file
4. **Use Hooks**: Import `useGetDataQuery`, `useMutationMutation` in your page
5. **Invalidate Tags**: Mutation should include `invalidatesTags: ["USERS"]` to trigger refetch

### RTK Query Pattern (copy-paste template)
```typescript
export const featureApi = baseApi.injectEndpoints({
  endpoints: (builder) => ({
    getData: builder.query<{ data: T[], meta: Meta }, QueryParams>({
      query: (params) => ({ url: "/admin/endpoint", method: "GET", params }),
      providesTags: ["TAG"],
    }),
    updateData: builder.mutation<{ data: T }, { id: string; updates: Partial<T> }>({
      query: ({ id, updates }) => ({ 
        url: `/admin/endpoint/${id}`, method: "PATCH", data: updates 
      }),
      invalidatesTags: ["TAG"],
    }),
  }),
});
export const { useGetDataQuery, useUpdateDataMutation } = featureApi;
```

### Dialog + Confirmation Pattern
```typescript
const [selectedItem, setSelectedItem] = useState(null);
const [confirmDialog, setConfirmDialog] = useState({ open: false, title: "", description: "", action: () => {} });

const handleDelete = (id, name) => {
  setConfirmDialog({
    open: true,
    title: "Delete Item",
    description: `Are you sure you want to delete "${name}"? This cannot be undone.`,
    action: async () => {
      await deleteItem(id).unwrap();
      toast.success("Deleted successfully");
    }
  });
};

// In JSX:
// <Button onClick={() => handleDelete(item._id, item.title)}><Trash2 /></Button>
// <AlertDialog open={confirmDialog.open} onOpenChange={(open) => ...}>
//   <AlertDialogTitle>{confirmDialog.title}</AlertDialogTitle>
//   <AlertDialogAction onClick={() => { confirmDialog.action(); setConfirmDialog({...open: false}); }}>
```

## File Organization
- **Pages**: `src/pages/Admin/{ManageUsers,ManageItems}.tsx`, `Analytics.tsx`, `Login.tsx`, `Profile.tsx`, `Unauthorized.tsx`
- **Components**: 
  - `ui/` - shadcn components (dialog.tsx, alert-dialog.tsx, table.tsx, button.tsx, etc.)
  - `layout/` - DashboardLayout.tsx, Navbar.tsx
  - `modules/Authentication/` - LoginForm.tsx only
- **Redux**: `src/redux/features/{auth,admin}/{admin.api,item.api,dashboard.api}.ts`
- **Utils**: `withAuth.tsx` (route guard), `generateRoutes.ts` (sidebar → routes), `getSidebarItems.ts`
- **Types**: `src/types/index.ts` - All user/item enums and interfaces
- **Config**: `src/config/index.ts` - Base URL, env vars
- **Path Alias**: `@/` → `src/` (vite.config.ts)

## Backend Integration Checklist

**Base URL**: `http://localhost:9000/api/v1/` (from `VITE_BASE_URL` .env)

**All endpoints return**:
```typescript
{ statusCode: number; success: boolean; message: string; meta?: { total, page, limit, totalPages }; data: T | T[] | null }
```

**Implemented Endpoints** (verify backend has these):
- POST `/auth/login` → `{ data: { user: IUser, accessToken: string } }`
- GET `/auth/me` → `{ data: IUser }` (requires cookie)
- GET `/admin/users?page=1&limit=10&searchTerm=...&isStatus=...` → `{ meta, data: IUser[] }`
- PATCH `/admin/users/:id/status` (body: `{ isStatus, isVerified? }`) → `{ data: IUser }`
- DELETE `/admin/users/:id` → `{ data: null }`
- GET `/admin/items?page=1&limit=10&searchTerm=...&status=...` → `{ meta, data: IItem[] }`
- PATCH `/admin/items/:id/status` (body: `{ status }`) → `{ data: IItem }`
- DELETE `/admin/items/:id` → `{ data: null }`
- GET `/admin/dashboard/stats` → `{ data: { totalUsers, activeUsers, ..., totalItems, ... } }`
- GET `/admin/dashboard/recent-activity?limit=5` → `{ data: { recentUsers, recentItems } }`

## Common Patterns
- **Toast Notifications**: `toast.success()`, `toast.error()` (Sonner)
- **Loading**: Show `Loader2` spinner or disable buttons with `isLoading` from query
- **Error Handling**: `error?.data?.message` fallback to generic message
- **Pagination**: Page state + limit in query, disable prev/next buttons at boundaries
- **Search**: Real-time state update (no debounce), API filters server-side
- **Status Display**: Color-coded badges via className conditionals

## Critical Implementation Details
1. **withAuth Race Condition Fix**: Waits for `!isLoading` before checking `data?.data?._id`—prevents redirect loops on auth check
2. **Dialog State Management**: Confirmation dialogs use controlled state, action callback executed before closing
3. **Owner Population**: Items endpoint returns `ownerId: IUser` (object), not string—handle both with `typeof check`
4. **Verify vs Suspend**: Verify sets BOTH `isStatus: ACTIVE` AND `isVerified: true`; suspend/activate only change status
5. **Root Redirect**: App.tsx routes root `/` to `/login` redirect—no home page exists
6. **Import Dialog/AlertDialog**: Must import from `@/components/ui/{dialog,alert-dialog}` (shadcn components)

## Dependencies Worth Knowing
- **React 19.1.1**: Latest hooks, no breaking changes from 18
- **Redux Toolkit 2.x**: Thunks, RTK Query built-in
- **Axios**: Not fetch—has interceptors for logging/auth
- **Zod**: Schema validation (used in LoginForm)
- **Tailwind 4**: @tailwindcss/vite plugin, updated CSS
- **Lucide Icons**: 2000+ icons (Eye, Trash2, Ban, CheckCircle, etc.)
- **Sonner**: Toast library (no shadcn toast component)
